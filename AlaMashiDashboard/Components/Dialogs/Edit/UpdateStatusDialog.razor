@namespace AlaMashi.AdminDashboard.Components.Dialogs
@using global::AdminDashboard.Services
@inject ApiService ApiService
@inject ISnackbar Snackbar
@inject LocalizationService Localization

<MudDialog ClassActions="dialog-actions-improved" ClassContent="dialog-content-smooth">
    <TitleContent>
        <div class="d-flex align-center gap-2 pa-2">
            <MudIcon Icon="@Icons.Material.Filled.Update" Color="Color.Info" Size="Size.Large" />
            <MudText Typo="Typo.h5" Class="font-weight-bold">@Localization.Get("dialog.update_order_status")</MudText>
        </div>
        <MudDivider />
    </TitleContent>

    <DialogContent>
        <MudStack Spacing="4" Class="pa-3">
            <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Dense="true">
                @Localization.Get("dialog.status_confirmation")
            </MudAlert>

            <MudPaper Elevation="0" Outlined="true" Class="pa-3">
                <MudGrid Spacing="3">
                    <MudItem xs="12">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">@Localization.Get("orders.order_id")</MudText>
                        <MudChip Size="Size.Medium" Color="Color.Primary" Icon="@Icons.Material.Filled.Receipt">
                            #@OrderId
                        </MudChip>
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-2">
                            @Localization.Get("dialog.current_status")
                        </MudText>
                        <MudChip Size="Size.Medium"
                                 Color="@GetStatusColor(CurrentStatus)"
                                 Icon="@GetStatusIcon(CurrentStatus)">
                            @GetLocalizedStatus(CurrentStatus)
                        </MudChip>
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-2">
                            @Localization.Get("dialog.new_status")
                        </MudText>
                        <MudChip Size="Size.Medium"
                                 Color="@GetStatusColor(NextStatus)"
                                 Icon="@GetStatusIcon(NextStatus)">
                            @GetLocalizedStatus(NextStatus)
                        </MudChip>
                    </MudItem>
                </MudGrid>
            </MudPaper>

            <div class="d-flex align-center justify-center">
                <MudIcon Icon="@Icons.Material.Filled.ArrowDownward" Color="Color.Success" Size="Size.Large" />
            </div>
        </MudStack>
    </DialogContent>

    <DialogActions>
        <MudStack Row="true" Spacing="2" Class="pa-2" Style="width:100%;" Justify="Justify.FlexEnd">
            <MudButton OnClick="Cancel"
                       Variant="Variant.Outlined"
                       Color="Color.Default"
                       StartIcon="@Icons.Material.Filled.Close"
                       Size="Size.Medium">
                @Localization.Get("common.cancel")
            </MudButton>
            <MudButton OnClick="UpdateStatus"
                       Variant="Variant.Filled"
                       Color="Color.Success"
                       Disabled="@isUpdating"
                       StartIcon="@Icons.Material.Filled.Check"
                       Size="Size.Medium"
                       Class="px-6">
                @if (isUpdating)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    <span>@Localization.Get("dialog.updating")</span>
                }
                else
                {
                    @Localization.Get("dialog.update")
                }
            </MudButton>
        </MudStack>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = null!;
    [Parameter] public int OrderId { get; set; }
    [Parameter] public string CurrentStatus { get; set; } = string.Empty;
    [Parameter] public string NextStatus { get; set; } = string.Empty;

    private bool isUpdating = false;

    private async Task UpdateStatus()
    {
        isUpdating = true;
        try
        {
            var updateRequest = new { NewStatus = NextStatus };
            var response = await ApiService.PatchJsonAsync<OrderStatusResponse>(
                $"/api/Orders/{OrderId}/status", updateRequest);

            if (response?.Status == "success")
            {
                Snackbar.Add(Localization.IsArabic
                    ? "تم تحديث حالة الطلب بنجاح!"
                    : "Order status updated successfully!", Severity.Success);
                MudDialog.Close(DialogResult.Ok(true));
            }
            else
            {
                Snackbar.Add(response?.Message ?? Localization.Get("common.failed"), Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"{Localization.Get("common.error")}: {ex.Message}", Severity.Error);
        }
        finally
        {
            isUpdating = false;
        }
    }

    private void Cancel() => MudDialog.Cancel();

    public class OrderStatusResponse
    {
        [JsonPropertyName("status")] public string Status { get; set; } = string.Empty;
        [JsonPropertyName("message")] public string Message { get; set; } = string.Empty;
    }

    private string GetLocalizedStatus(string status) => status switch
    {
        "Pending" => Localization.Get("orders.pending"),
        "InPreparation" => Localization.Get("orders.in_preparation"),
        "OutForDelivery" => Localization.Get("orders.out_for_delivery"),
        "Delivered" => Localization.Get("orders.delivered"),
        "Canceled" => Localization.Get("orders.canceled"),
        _ => status
    };

    private Color GetStatusColor(string status) => status switch
    {
        "Pending" => Color.Warning,
        "InPreparation" => Color.Info,
        "OutForDelivery" => Color.Secondary,
        "Delivered" => Color.Success,
        "Canceled" => Color.Error,
        _ => Color.Default
    };

    private string GetStatusIcon(string status) => status switch
    {
        "Pending" => Icons.Material.Filled.Schedule,
        "InPreparation" => Icons.Material.Filled.Inventory,
        "OutForDelivery" => Icons.Material.Filled.LocalShipping,
        "Delivered" => Icons.Material.Filled.CheckCircle,
        "Canceled" => Icons.Material.Filled.Cancel,
        _ => Icons.Material.Filled.Info
    };
}