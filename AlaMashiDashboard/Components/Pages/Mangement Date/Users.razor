@page "/users"
@inject ApiService ApiService
@inject ISnackbar Snackbar
@inject IJSRuntime JS
@inject IDialogService DialogService

<PageTitle>User Management</PageTitle>

<!-- Page Header -->
<div class="page-header mb-4 slide-in">
    <div class="d-flex justify-space-between align-center flex-wrap">
        <div>
            <MudText Typo="Typo.h4" Class="font-weight-bold mb-1">
                <MudIcon Icon="@Icons.Material.Filled.People" Class="mr-2" />
                User Management
            </MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">Manage and view all registered users in the system</MudText>
        </div>
        <div class="d-flex gap-2 mt-2 mt-md-0">
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Secondary"
                       StartIcon="@Icons.Material.Filled.Refresh"
                       OnClick="LoadDataAsync">
                Refresh
            </MudButton>
            <MudButton Variant="Variant.Filled"
                       Color="Color.Success"
                       StartIcon="@Icons.Material.Filled.FileDownload"
                       OnClick="ExportToCSV"
                       Disabled="@(usersList == null || !usersList.Any())">
                Export CSV
            </MudButton>
        </div>
    </div>
</div>

@if (isLoading)
{
    <MudCard Elevation="2" Class="fade-in">
        <MudCardContent>
            <div class="d-flex flex-column justify-center align-center pa-8">
                <MudProgressCircular Indeterminate="true" Size="Size.Large" Color="Color.Primary" />
                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-4">Loading users...</MudText>
            </div>
        </MudCardContent>
    </MudCard>
}
else if (usersList != null && usersList.Any())
{
    <MudCard Elevation="2" Class="data-table-card fade-in">
        <MudCardContent Class="pa-0">
            <MudTable Items="@GetFilteredUsers()"
                      Hover="true"
                      Breakpoint="Breakpoint.Sm"
                      FixedHeader="true"
                      Height="calc(100vh - 320px)"
                      Class="custom-table">

                <ToolBarContent>
                    <MudTextField @bind-Value="_searchString"
                                  Placeholder="Search users..."
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Filled.Search"
                                  IconSize="Size.Medium"
                                  Immediate="true"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense"
                                  Class="mr-2"
                                  Style="max-width: 400px;" />
                    <MudSpacer />
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        Showing <strong>@GetFilteredUsers().Count()</strong> of <strong>@usersList.Count</strong> users
                    </MudText>
                </ToolBarContent>

                <HeaderContent>
                    <MudTh>
                        <MudTableSortLabel SortBy="new Func<UserDto, object>(x => x.UserId)">
                            ID
                        </MudTableSortLabel>
                    </MudTh>
                    <MudTh>
                        <MudTableSortLabel SortBy="new Func<UserDto, object>(x => x.UserName)">
                            Username
                        </MudTableSortLabel>
                    </MudTh>
                    <MudTh>Email</MudTh>
                    <MudTh>Phone</MudTh>
                    <MudTh>Role</MudTh>
                    <MudTh Style="text-align: right;">Actions</MudTh>
                </HeaderContent>

                <RowTemplate>
                    <MudTd DataLabel="ID">
                        <MudChip Size="Size.Small" Color="Color.Default">@context.UserId</MudChip>
                    </MudTd>
                    <MudTd DataLabel="Username">
                        <div class="d-flex align-center">
                            <MudAvatar Size="Size.Small" Color="@(context.IsAdmin? Color.Error: Color.Primary)" Class="mr-2">
                                @context.UserName.Substring(0, 1).ToUpper()
                            </MudAvatar>
                            <MudText Typo="Typo.body2" Class="font-weight-medium">@context.UserName</MudText>
                        </div>
                    </MudTd>
                    <MudTd DataLabel="Email">
                        <div class="d-flex align-center">
                            <MudIcon Icon="@Icons.Material.Filled.Email" Size="Size.Small" Color="Color.Info" Class="mr-1" />
                            <MudText Typo="Typo.body2" Color="Color.Secondary">@context.Email</MudText>
                        </div>
                    </MudTd>
                    <MudTd DataLabel="Phone">
                        <div class="d-flex align-center">
                            <MudIcon Icon="@Icons.Material.Filled.Phone" Size="Size.Small" Color="Color.Success" Class="mr-1" />
                            <MudText Typo="Typo.body2" Color="Color.Secondary">@context.Phone</MudText>
                        </div>
                    </MudTd>
                    <MudTd DataLabel="Role">
                        @if (context.IsAdmin)
                        {
                            <MudChip Size="Size.Small"
                                     Color="Color.Error"
                                     Icon="@Icons.Material.Filled.AdminPanelSettings">
                                Admin
                            </MudChip>
                        }
                        else
                        {
                            <MudChip Size="Size.Small"
                                     Color="Color.Default"
                                     Icon="@Icons.Material.Filled.Person">
                                User
                            </MudChip>
                        }
                    </MudTd>
                    <MudTd DataLabel="Actions" Style="text-align: right;">
                        <MudTooltip Text="View Details">
                            <MudIconButton Icon="@Icons.Material.Filled.Visibility"
                                           Size="Size.Small"
                                           Color="Color.Default"
                                           OnClick="@(() => ViewUser(context))" />
                        </MudTooltip>
                        @if (!context.IsAdmin)
                        {
                            <MudTooltip Text="Promote to Admin">
                                <MudIconButton Icon="@Icons.Material.Filled.AdminPanelSettings"
                                               Size="Size.Small"
                                               Color="Color.Warning"
                                               OnClick="@(() => PromoteToAdmin(context))" />
                            </MudTooltip>
                        }
                        <MudTooltip Text="Edit">
                            <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                           Size="Size.Small"
                                           Color="Color.Info"
                                           OnClick="@(() => OpenEditDialog(context))" />
                        </MudTooltip>
                        <MudTooltip Text="Delete">
                            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                           Size="Size.Small"
                                           Color="Color.Error"
                                           OnClick="@(() => DeleteUser(context))" />
                        </MudTooltip>
                    </MudTd>
                </RowTemplate>

                <PagerContent>
                    <MudTablePager PageSizeOptions="new int[] { 10, 25, 50, 100 }" />
                </PagerContent>
            </MudTable>
        </MudCardContent>
    </MudCard>

    <!-- Stats Footer -->
    <MudPaper Class="pa-3 mt-3 slide-up" Elevation="1">
        <div class="d-flex justify-space-between align-center flex-wrap gap-2">
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                <MudIcon Icon="@Icons.Material.Filled.Group" Size="Size.Small" Class="mr-1" />
                Total Users: <strong>@usersList.Count</strong>
            </MudText>
            <MudText Typo="Typo.body2" Color="Color.Error">
                <MudIcon Icon="@Icons.Material.Filled.AdminPanelSettings" Size="Size.Small" Class="mr-1" />
                Admins: <strong>@usersList.Count(u => u.IsAdmin)</strong>
            </MudText>
            <MudText Typo="Typo.body2" Color="Color.Primary">
                <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" Class="mr-1" />
                Regular Users: <strong>@usersList.Count(u => !u.IsAdmin)</strong>
            </MudText>
        </div>
    </MudPaper>
}
else
{
    <MudCard Elevation="2" Class="fade-in">
        <MudCardContent Class="pa-8">
            <div class="d-flex flex-column align-center text-center">
                <MudIcon Icon="@Icons.Material.Filled.PersonOff"
                         Size="Size.Large"
                         Color="Color.Secondary"
                         Class="mb-4 pulse-icon"
                         Style="font-size: 5rem;" />
                <MudText Typo="Typo.h6" Class="mb-2">No Users Found</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
                    Start by adding your first user to the system.
                </MudText>
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Secondary"
                           OnClick="LoadDataAsync"
                           StartIcon="@Icons.Material.Filled.Refresh">
                    Retry
                </MudButton>
            </div>
        </MudCardContent>
    </MudCard>
}

<style>
    .page-header {
        animation: slideInDown 0.5s ease-out;
    }

    .fade-in {
        animation: fadeIn 0.5s ease-in;
    }

    .slide-in {
        animation: slideInLeft 0.5s ease-out;
    }

    .slide-up {
        animation: slideUp 0.5s ease-out;
    }

    .pulse-icon {
        animation: pulse 3s infinite;
    }

    .data-table-card {
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }

    ::deep .mud-table-row:hover {
        background-color: rgba(59, 130, 246, 0.05) !important;
        transform: scale(1.01);
    }

    @@keyframes slideInDown {
        from {
            opacity: 0;
            transform: translateY(-30px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    @@keyframes slideInLeft {
        from {
            opacity: 0;
            transform: translateX(-30px);
        }

        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    @@keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @@keyframes pulse {
        0%, 100% {
            transform: scale(1);
        }

        50% {
            transform: scale(1.05);
        }
    }
</style>

@code {
    private bool isLoading = true;
    private List<UserDto>? usersList;
    private string _searchString = "";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        usersList = null;
        isLoading = true;
        StateHasChanged();

        try
        {
            var usersL = await ApiService.GetAsync<ApiService.ApiResponse<List<UserDto>>>("/api/Users/all");
            usersList = usersL?.Data;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading users: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private IEnumerable<UserDto> GetFilteredUsers()
    {
        if (usersList == null) return Enumerable.Empty<UserDto>();
        if (string.IsNullOrWhiteSpace(_searchString)) return usersList;

        return usersList.Where(u =>
            u.UserName.Contains(_searchString, StringComparison.OrdinalIgnoreCase) ||
            u.Email.Contains(_searchString, StringComparison.OrdinalIgnoreCase) ||
            u.Phone.Contains(_searchString, StringComparison.OrdinalIgnoreCase) ||
            u.UserId.ToString().Contains(_searchString)
        );
    }

    private async Task PromoteToAdmin(UserDto user)
    {
        var parameters = new DialogParameters
        {
            ["ContentText"] = $"Are you sure you want to promote '{user.UserName}' to Admin? This will grant them full administrative privileges.",
            ["ButtonText"] = "Promote",
            ["Color"] = Color.Warning
        };

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small };
        var dialog = await DialogService.ShowAsync<ConfirmDialog>("Promote to Admin", parameters, options);
        var result = await dialog.Result;

        if (result.Canceled) return;

        try
        {
            var response = await ApiService.PostAsync<object>($"/api/Users/{user.UserId}/promote-to-admin", null);

            Snackbar.Add($"User '{user.UserName}' has been promoted to Admin successfully!", Severity.Success);
            await LoadDataAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to promote user: {ex.Message}", Severity.Error);
        }
    }

    private void ViewUser(UserDto user)
    {
        Snackbar.Add($"Viewing details for {user.UserName}", Severity.Info);
    }

    private void OpenEditDialog(UserDto user)
    {
        Snackbar.Add($"Edit feature for {user.UserName} - Coming soon", Severity.Info);
    }

    private async Task DeleteUser(UserDto user)
    {
        var parameters = new DialogParameters
        {
            ["ContentText"] = $"Are you sure you want to delete user '{user.UserName}'? This action cannot be undone.",
            ["ButtonText"] = "Delete",
            ["Color"] = Color.Error
        };

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small };
        var dialog = await DialogService.ShowAsync<ConfirmDialog>("Delete User", parameters, options);
        var result = await dialog.Result;

        if (result.Canceled) return;

        try
        {
            await ApiService.DeleteAsync($"/api/Users/{user.UserId}");
            Snackbar.Add($"User '{user.UserName}' has been deleted successfully!", Severity.Success);
            await LoadDataAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to delete user: {ex.Message}", Severity.Error);
        }
    }

    private async Task ExportToCSV()
    {
        if (usersList == null || !usersList.Any()) return;

        var filtered = GetFilteredUsers().ToList();
        var csv = new System.Text.StringBuilder();
        csv.AppendLine("User ID,Username,Email,Phone,Role");

        foreach (var user in filtered)
        {
            csv.AppendLine($"{user.UserId},{user.UserName},{user.Email},{user.Phone},{(user.IsAdmin ? "Admin" : "User")}");
        }

        var bytes = System.Text.Encoding.UTF8.GetBytes(csv.ToString());
        var base64 = Convert.ToBase64String(bytes);
        await JS.InvokeVoidAsync("eval", $"(function(){{var a=document.createElement('a');a.href='data:text/csv;base64,{base64}';a.download='Users_{DateTime.Now:yyyyMMdd_HHmmss}.csv';a.click();}})()");

        Snackbar.Add($"Exported {filtered.Count} users successfully!", Severity.Success);
    }

    public class UserDto
    {
        [JsonPropertyName("userId")] public int UserId { get; set; }
        [JsonPropertyName("userName")] public string UserName { get; set; } = string.Empty;
        [JsonPropertyName("email")] public string Email { get; set; } = string.Empty;
        [JsonPropertyName("phone")] public string Phone { get; set; } = string.Empty;
        [JsonPropertyName("isAdmin")] public bool IsAdmin { get; set; }
    }
}

@* Confirm Dialog Component *@
@code {
    public class ConfirmDialog : ComponentBase
    {
        [CascadingParameter] MudDialogInstance MudDialog { get; set; } = null!;
        [Parameter] public string ContentText { get; set; } = string.Empty;
        [Parameter] public string ButtonText { get; set; } = "Confirm";
        [Parameter] public Color Color { get; set; } = Color.Primary;

        protected override void BuildRenderTree(Microsoft.AspNetCore.Components.Rendering.RenderTreeBuilder builder)
        {
            // Dialog will be rendered by MudBlazor
        }
    }
}